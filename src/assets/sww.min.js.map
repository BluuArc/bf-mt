{"version":3,"file":"sww.min.js","sources":["../src/postAll.js","../src/utils.js","../src/createDisposableWorker.js","../src/run.js","../src/post.js","../src/register.js","../src/unregister.js","../src/create.js","../src/index.js"],"sourcesContent":["// import { invalidObjectsArray, isArrayOf, notArray, returnNull, wrongLength, wrongObjects } from './utils'\r\nimport { isValid, argumentError } from './utils'\r\n\r\nconst makeOptionsFor = arr => {\r\n  return {\r\n    expected: 'an array of arrays, an array of objects, or an array of strings',\r\n    received: arr,\r\n    extraInfo: 'If an array of arrays, ' +\r\n      'it must have the same length as the actions registered for this worker.\\n' +\r\n      'If an array of objects, every object must containing two fields:\\n* message\\n* args'\r\n  }\r\n}\r\nexport function postAll (arr = []) {\r\n  if (isValid(arr)(['arraysArray', 'postParamsArray', 'stringsArray'])) {\r\n    if (arr.length === 0) return Promise.all(this.actions.map(({ message }) => this.postMessage(message)))\r\n\r\n    if (arr.every(item => typeof item === 'string')) {\r\n      return Promise.all(arr.map(msg => this.postMessage(msg)))\r\n    }\r\n\r\n    if (arr.every(item => typeof item === 'object' && !Array.isArray(item))) {\r\n      return Promise.all(arr.map(({ message, args }) => this.postMessage(message, args)))\r\n    }\r\n\r\n    if (arr.every(item => Array.isArray(item)) && arr.length === this.actions.length) {\r\n      return Promise.all(arr.map((args, index) => this.postMessage(this.actions[index].message, args)))\r\n    }\r\n  }\r\n\r\n  console.error(argumentError(makeOptionsFor(arr)))\r\n  return null\r\n}\r\n","// Argument validation\r\nconst isValidObjectWith = fields => obj =>\r\n  !!obj && !Array.isArray(obj) && fields.every(field => obj.hasOwnProperty(field))\r\n\r\nconst isValidAction = obj => {\r\n  return isValidObjectWith(['message', 'func'])(obj) &&\r\n    typeof obj.func === 'function' && typeof obj.message === 'string'\r\n}\r\n\r\nconst isValidActionsArray = arr => arr.every(isValidAction)\r\n\r\nconst isValidPostParams = obj => {\r\n  return isValidObjectWith(['message', 'args'])(obj) &&\r\n    Array.isArray(obj.args) && typeof obj.message === 'string'\r\n}\r\n\r\nconst isValidPostParamsArray = arr => arr.every(isValidPostParams)\r\n\r\nconst isValidObjectsArray = arr => (fields = []) =>\r\n  arr.every(isValidObjectWith(fields))\r\n\r\nconst testArray = {\r\n  'actionsArray': arr => isValidActionsArray(arr),\r\n  'arraysArray': arr => arr.every(item => Array.isArray(item)),\r\n  'objectsArray': arr => isValidObjectsArray(arr)(),\r\n  'postParamsArray': arr => isValidPostParamsArray(arr),\r\n  'stringsArray': arr => arr.every(item => typeof item === 'string')\r\n}\r\n\r\nconst isValidArg = arg => type => {\r\n  if (type === 'null') return arg === null\r\n  if (type === 'undefined') return arg === undefined\r\n  if (type === 'action') return isValidAction(arg)\r\n  if (Array.isArray(arg)) {\r\n    if (type !== 'array' && !testArray[type]) return false\r\n    if (type === 'array') return true\r\n    return testArray[type](arg)\r\n  }\r\n  if (arg) return typeof arg === type.toString() // eslint-disable-line\r\n  return false\r\n}\r\n\r\nconst isValid = argument => (types = null) => {\r\n  if (Array.isArray(types)) return types.some(type => isValidArg(argument)(type))\r\n  if (isValidArg(argument)(types)) return true\r\n  return false\r\n}\r\n\r\n// Argument error builder\r\nconst argumentError = ({ expected = '', received, extraInfo = '' }) => {\r\n  try {\r\n    return new TypeError(`${'You should provide ' + expected}${'\\n' + extraInfo}${'\\nReceived: ' + JSON.stringify(received)}`)\r\n  } catch (err) {\r\n    if (err.message === 'Converting circular structure to JSON') {\r\n      return new TypeError(`${'You should provide ' + expected}${'\\n' + extraInfo}${'\\nReceived a circular structure: ' + received}`)\r\n    }\r\n    throw err\r\n  }\r\n}\r\n\r\n// Response builder\r\nconst makeResponse = work => `\r\n  self.onmessage = event => {\r\n    const args = event.data.message.args\r\n    if (args) {\r\n      return Promise.resolve((${work}).apply(null, args))\r\n        .then(result => { self.postMessage(result) })\r\n        .then(() => close())\r\n        .catch(err => setTimeout(() => { throw err; }))\r\n    }\r\n    return Promise\r\n      .resolve((${work})())\r\n      .then(result => { self.postMessage(result) })\r\n      .then(() => close())\r\n      .catch(err => setTimeout(() => { throw err; }))\r\n  }\r\n`\r\n\r\nexport {\r\n  makeResponse,\r\n  argumentError,\r\n  isValid\r\n}\r\n","export const createDisposableWorker = response => {\r\n  const URL = window.URL || window.webkitURL\r\n  const blob = new Blob([response], { type: 'application/javascript' }) // eslint-disable-line\r\n  const objectURL = URL.createObjectURL(blob)\r\n  const worker = new Worker(objectURL) // eslint-disable-line\r\n  worker.post = message =>\r\n    new Promise((resolve, reject) => {\r\n      worker.onmessage = event => {\r\n        URL.revokeObjectURL(objectURL)\r\n        resolve(event.data)\r\n      }\r\n      worker.onerror = e => {\r\n        console.error(`Error: Line ${e.lineno} in ${e.filename}: ${e.message}`)\r\n        reject(e)\r\n      }\r\n      worker.postMessage({ message })\r\n    })\r\n  return worker\r\n}\r\n","import { argumentError, isValid, makeResponse } from './utils'\r\nimport { createDisposableWorker } from './createDisposableWorker'\r\n\r\nexport const run = (work = null, args) => {\r\n  const validWork = isValid(work)('function')\r\n  const validArgs = isValid(args)(['array', 'undefined'])\r\n  if (validWork && validArgs) {\r\n    const worker = createDisposableWorker(makeResponse(work))\r\n    return worker.post({ args })\r\n  }\r\n  if (!validWork) console.error(argumentError({ expected: 'a function', received: work }))\r\n  if (!validArgs) console.error(argumentError({ expected: 'an array', received: args }))\r\n  return null\r\n}\r\n","import { argumentError, isValid } from './utils'\r\nimport { run } from './run'\r\n\r\nconst warnWork = msg => {\r\n  console.warn(`WARN! ${msg} is not a registered action for this worker`)\r\n  return `${msg} is not a registered action for this worker`\r\n}\r\n\r\nexport const post = actions => (msg = null, args) => {\r\n  const validMessage = isValid(msg)('string')\r\n  const validArgs = isValid(args)(['array', 'undefined'])\r\n  if (validMessage && validArgs) {\r\n    const work = actions\r\n      .filter(({ message }) => JSON.stringify(message) === JSON.stringify(msg))\r\n      .map(action => action.func)\r\n      .pop()\r\n\r\n    if (!work) return run(warnWork, [JSON.stringify(msg)])\r\n    if (args) return run(work, args)\r\n    return run(work)\r\n  }\r\n\r\n  if (!validMessage) console.error(argumentError({ expected: 'a string', received: msg }))\r\n  if (!validArgs) console.error(argumentError({ expected: 'an array', received: args }))\r\n  return null\r\n}\r\n","import { argumentError, isValid } from './utils'\r\n\r\nconst isActionOf = actions => newAction =>\r\n  actions.some(action => action.message === newAction.message)\r\n\r\nconst warnMsg = action =>\r\n  `WARN! An action with message \"${action.message}\" is already registered for this worker`\r\n\r\nconst pushInto = actions => action => {\r\n  if (isActionOf(actions)(action)) {\r\n    console.warn(warnMsg(action))\r\n    return actions.length\r\n  }\r\n  return actions.push(action)\r\n}\r\n\r\nconst makeOptionsFor = action => {\r\n  return {\r\n    expected: 'an array of actions or an action',\r\n    received: action,\r\n    extraInfo: 'Every action should be an object containing two fields:\\n* message\\n* func'\r\n  }\r\n}\r\n\r\nexport const register = actions => (action = null) => {\r\n  if (isValid(action)(['action', 'actionsArray'])) {\r\n    if (Array.isArray(action)) {\r\n      return action.reduce((actions, action) => {\r\n        pushInto(actions)(action)\r\n        return actions\r\n      }, actions).length\r\n    }\r\n\r\n    return pushInto(actions)(action)\r\n  }\r\n  console.error((argumentError(makeOptionsFor(action))))\r\n  return null\r\n}\r\n","import { argumentError, isValid } from './utils'\r\n\r\nconst removeFrom = actions => msg => {\r\n  const index = actions.findIndex(({ message }) => message === msg)\r\n  index === -1\r\n    ? console.warn(`WARN! Impossible to unregister action with message \"${msg}\".\\nIt is not a registered action for this worker.`)\r\n    : actions.splice(index, 1)\r\n  return actions\r\n}\r\n\r\nconst makeOptions = msg => {\r\n  return {\r\n    expected: 'an array of strings or a string',\r\n    received: msg\r\n  }\r\n}\r\n\r\nexport const unregister = actions => (msg = null) => {\r\n  if (isValid(msg)(['string', 'stringsArray'])) {\r\n    if (Array.isArray(msg)) {\r\n      return msg.reduce((actions, message) => {\r\n        removeFrom(actions)(message)\r\n        return actions\r\n      }, actions).length\r\n    }\r\n    return removeFrom(actions)(msg).length\r\n  }\r\n\r\n  console.error(argumentError(makeOptions(msg)))\r\n  return null\r\n}\r\n","import { argumentError, isValid } from './utils'\r\nimport { post } from './post'\r\nimport { postAll } from './postAll'\r\nimport { register } from './register'\r\nimport { unregister } from './unregister'\r\n\r\nconst options = actions => {\r\n  return {\r\n    expected: 'an array of objects',\r\n    received: actions,\r\n    extraInfo: 'Every action should be an object containing two fields:\\n* message\\n* func'\r\n  }\r\n}\r\n\r\nexport const create = (actions = []) => {\r\n  if (isValid(actions)('actionsArray')) {\r\n    return {\r\n      actions: actions,\r\n      postMessage: post(actions),\r\n      postAll: postAll,\r\n      register: register(actions),\r\n      unregister: unregister(actions)\r\n    }\r\n  }\r\n  console.error(argumentError(options(actions)))\r\n  return null\r\n}\r\n","import { create } from './create'\r\nimport { run } from './run'\r\n\r\nconst createWrapper = () => {\r\n  if (!window.Worker) {\r\n    console.error('This browser does not support Workers.')\r\n    return null\r\n  }\r\n  if (!(window.URL.createObjectURL || window.webkitURL.createObjectURL)) {\r\n    console.error('This browser does not have URL.createObjectURL method.')\r\n    return null\r\n  }\r\n  return { create, run }\r\n}\r\n\r\nconst WorkerWrapper = createWrapper()\r\n\r\nexport default WorkerWrapper\r\n"],"names":["postAll","arr","isValid","length","Promise","all","this","actions","map","message","_this","postMessage","every","item","msg","Array","isArray","args","index","error","argumentError","makeOptionsFor","isValidObjectWith","obj","fields","hasOwnProperty","field","isValidAction","func","isValidActionsArray","isValidPostParams","isValidPostParamsArray","isValidObjectsArray","testArray","isValidArg","type","arg","undefined","toString","types","some","argument","expected","received","extraInfo","TypeError","JSON","stringify","err","makeResponse","work","createDisposableWorker","URL","window","webkitURL","blob","Blob","response","objectURL","createObjectURL","worker","Worker","post","resolve","reject","onmessage","revokeObjectURL","event","data","onerror","e","lineno","filename","run","validWork","validArgs","console","warnWork","warn","validMessage","filter","action","pop","isActionOf","newAction","warnMsg","pushInto","push","register","reduce","removeFrom","findIndex","splice","makeOptions","unregister","options","create","createWrapper","WorkerWrapper"],"mappings":"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"}